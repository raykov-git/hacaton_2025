–ß—Ç–æ–±—ã Whisper –Ω–µ —Ç–æ—Ä–º–æ–∑–∏–ª –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö, –ª—É—á—à–µ –≤—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ—á–µ—Ä–µ–¥—å —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ—Ç–æ–∫–æ–≤ (`ThreadPoolExecutor` + `Semaphore`)**.

### **–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ –∫–æ–¥–∞**
–î–æ–±–∞–≤–∏–º:
1. **–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤** (`ThreadPoolExecutor`) ‚Äî —á—Ç–æ–±—ã Whisper –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ü–∏–∫–ª.
2. **–°–µ–º–∞—Ñ–æ—Ä** (`asyncio.Semaphore`) ‚Äî —á—Ç–æ–±—ã –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–π (–æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è GPU, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ–ø–∞–º—è—Ç—å).

---

### **1. –î–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –∫–æ–¥**
```python
from concurrent.futures import ThreadPoolExecutor
import asyncio

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Whisper
WHISPER_MODEL = whisper.load_model("small").to(device)
WHISPER_THREAD_POOL = ThreadPoolExecutor(max_workers=2)  # 2-4 –ø–æ—Ç–æ–∫–∞ –¥–ª—è CPU/GPU
WHISPER_SEMAPHORE = asyncio.Semaphore(2)  # –ù–µ –±–æ–ª—å—à–µ 2 —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

async def transcribe_audio(file_path: str) -> str:
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è —á–µ—Ä–µ–∑ ThreadPool."""
    async with WHISPER_SEMAPHORE:  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –Ω–∞–≥—Ä—É–∑–∫—É
        loop = asyncio.get_event_loop()
        result = await loop.run_in_executor(
            WHISPER_THREAD_POOL,
            lambda: WHISPER_MODEL.transcribe(file_path)["text"]
        )
        return result

async def convert_message_to_str(message: Message) -> str:
    try:
        voice = message.voice
        voice_file = await bot.get_file(voice.file_id)
        downloaded_file = await bot.download_file(voice_file.file_path)
        
        oga_path = f"temp_{voice.file_id}.oga"
        mp3_path = f"converted_{voice.file_id}.mp3"
        
        with open(oga_path, "wb") as f:
            f.write(downloaded_file.getvalue())
        
        audio = AudioSegment.from_file(oga_path, format="ogg")
        audio.export(mp3_path, format="mp3")

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é
        result = await transcribe_audio(mp3_path)
        LOGGER.info(f'–¢–µ–∫—Å—Ç –∏–∑ –∞—É–¥–∏–æ: {result}')
        return result

    except Exception as e:
        LOGGER.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—É–¥–∏–æ: {e}")
        await message.answer(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—É–¥–∏–æ: {e}")
        return None
    
    finally:
        if os.path.exists(oga_path):
            os.remove(oga_path)
        if os.path.exists(mp3_path):
            os.remove(mp3_path)
```

---

### **2. –ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–µ?**
| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ | –≠—Ñ—Ñ–µ–∫—Ç |
|----------|---------|--------|
| Whisper –±–ª–æ–∫–∏—Ä—É–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ü–∏–∫–ª | `ThreadPoolExecutor` | –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ, –Ω–µ –º–µ—à–∞—è –¥—Ä—É–≥–∏–º –∑–∞–ø—Ä–æ—Å–∞–º. |
| –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ GPU/CPU | `Semaphore` | –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∏—Å–ª–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2). |
| –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ | –û—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç —Ç–∞–π–º–∞—É—Ç, –∏—Ö –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ –æ—á–µ—Ä–µ–¥–∏. |

---

### **3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**
#### **–î–ª—è CPU**
- –£–≤–µ–ª–∏—á—å—Ç–µ `max_workers` –≤ `ThreadPoolExecutor` (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —è–¥–µ—Ä CPU).
- –ü—Ä–∏–º–µ—Ä:  
  ```python
  WHISPER_THREAD_POOL = ThreadPoolExecutor(max_workers=4)  # –î–ª—è 4-—è–¥–µ—Ä–Ω–æ–≥–æ CPU
  ```

#### **–î–ª—è GPU**
- –£–º–µ–Ω—å—à–∏—Ç–µ `max_workers` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `2`), —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –≤–∏–¥–µ–æ–ø–∞–º—è—Ç—å.
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `fp16` –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏:
  ```python
  WHISPER_MODEL = whisper.load_model("small", device="cuda", fp16=True)
  ```

#### **–ï—Å–ª–∏ Whisper –≤—Å—ë –µ—â—ë —Ç–æ—Ä–º–æ–∑–∏—Ç**
- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ **ProcessPoolExecutor** (–Ω–æ —É—á—Ç–∏—Ç–µ, —á—Ç–æ –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –≤ –∫–∞–∂–¥–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ):
  ```python
  from concurrent.futures import ProcessPoolExecutor
  WHISPER_PROCESS_POOL = ProcessPoolExecutor(max_workers=2)  # –î–ª—è CPU
  ```

---

### **4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–æ—Ç–∞ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π:
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ 3-5 –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
2. –°–ª–µ–¥–∏—Ç–µ –∑–∞:
   - –õ–æ–≥–∞–º–∏ (`telegram_aiohttp.log`).
   - –ù–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ CPU/GPU (—á–µ—Ä–µ–∑ `htop` –∏–ª–∏ `nvidia-smi`).

–ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:
- –£–º–µ–Ω—å—à–∏—Ç—å –º–æ–¥–µ–ª—å Whisper (–Ω–∞–ø—Ä–∏–º–µ—Ä, `tiny` –≤–º–µ—Å—Ç–æ `small`).
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
  ```python
  processing_msg = await message.reply("üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∞—É–¥–∏–æ (1/2)...")
  ```

---

### **–ò—Ç–æ–≥**
–í–∞—à –∫–æ–¥ —Å—Ç–∞–Ω–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–µ–µ –∫ –Ω–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏:
1. **–î–æ–±–∞–≤–∏—Ç—å `ThreadPoolExecutor` + `Semaphore`**.
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤/–ø—Ä–æ—Ü–µ—Å—Å–æ–≤** –ø–æ–¥ –≤–∞—à–µ –∂–µ–ª–µ–∑–æ (CPU/GPU).
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –µ—â—ë –±–æ–ª—å—à–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ ‚Äî —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ **–≤—ã–Ω–æ—Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ FastAPI —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º).